<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Code Development - DE3-TBD</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Code Development";
    var mkdocs_page_input_path = "CodeDevelopement.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> DE3-TBD</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <p class="caption"><span class="caption-text">Getting Started</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../software/">Software</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../hardware/">Hardware</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Project Guide</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../CodeExecutionInSimulation/">Execution in Simulation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../real/">Execution in Reality</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../animationcreation/">Creating Animation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../lightsource/">Panda Torch</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Image/">Capturing Photos</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Processing%20Photos/">Processing Photos</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Troubleshooting/">Troubleshooting</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Project Development</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../betatest/">Lo-Fi Development</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Code Development</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#code-structure">Code Structure</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#main-code-pandalightpaint">Main Code (pandaLightPaint)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#set-up">Set Up</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#modifiable-variables">Modifiable variables</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#main-execution-set-up">Main Execution Set Up</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#main-execution-loop">Main Execution Loop</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#gotopose-function">goToPose Function</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#shakehand-function">shakeHand Function</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#goonpath-function">goOnPath Function</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#lighton-function">lightOn Function</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#lightoff-function">lightOff Function</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#storing-animation-frames">Storing Animation (frames)</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../error/">Error Detection</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Evaluation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Succesful%20Achievements/">Succesful Achievements</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../fail/">Failed Attempts</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../evaluation/">Future Development</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">About</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../resource/">Resources</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../vid/">Videos</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../about/">Team</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">DE3-TBD</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Project Development &raquo;</li>
        
      
    
    <li>Code Development</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="code-development">Code Development</h2>
<p>This section talks about how the final python code works and why it is set up in this way. The final code is available on GitHub at this link <a href="https://github.com/HarveyU1/LightPaintingRobot">here</a>.</p>
<p>&nbsp;</p>
<h4 id="code-structure">Code Structure</h4>
<hr />
<p>There are two main python files which are used to get the panda robot to light paint.</p>
<p>-pandaLightPaint is the main python file which is executed from ROS to carry out motion planning for each frame of the animation and then executes this motion plan by moving the end effector and controlling the gripper position.</p>
<p>-frames is the python file in which the cartesian based trajectory is stored for a complete animation. This is imported by pandaLightPaint and informs the motion plan which is calculated.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h4 id="main-code-pandalightpaint">Main Code (pandaLightPaint)</h4>
<hr />
<p>The main python code that is launched from the terminal.</p>
<h6 id="set-up">Set Up</h6>
<hr />
<p>First, the required python modules are imported, ensure that all of these are installed in your python installation within ROS. Note ROS specific modules such as different message formats which allow communication between nodes.</p>
<pre><code class="python">#!/usr/bin/env python
#ROS specific
import sys
import copy
import rospy
import moveit_commander
import moveit_msgs.msg
import geometry_msgs.msg
from std_msgs.msg import String, Float64MultiArray, MultiArrayDimension, Float64
from moveit_commander.conversions import pose_to_list
</code></pre>

<p>Next, the generic python packages are imported. math.pi is required for robot angle calculations which are based in radians</p>
<pre><code class="python">from math import pi
import tf
</code></pre>

<p>Finally, the list framelist is imported from the frames python file which is stored alongside pandaLightPaint</p>
<pre><code class="python">from frames import framelist
</code></pre>

<p>&nbsp;</p>
<h6 id="modifiable-variables">Modifiable variables</h6>
<hr />
<p>These are the variables which can be changed to modify the behaviour of the robot. Some of these are useful to modify when troubleshooting for problems as they can often help prevent errors.</p>
<p>The offset coordinates are the cartesian coordinates in metres of the starting position for all frame drawing. The frame coordinates, in framelist, are provided w.r.t to a central local origin point. In the case of the butterfly, this is the centre of its body. The offset coordinated oOffCords specify the location of the frames local coordinate system relative to the robots coordinate system which has an origin located at the base of the arm. By default, the offset coordinates are set to 0.5 metres in front of the robot(x-axis) and 0.5 metres height above the base of the robot(z-axis). This always for a good amount of redundancy when drawing frames as the arm is well within the dexterous workspace.</p>
<pre><code class="python">oOffCords = [0.5,0,0.5]
</code></pre>

<p>The offset rotation specifies the desired pitch, roll and yaw of the end effector during light painting. When motion planning this is added as a constraint to ensure the end effector is always facing in the same direction. This means that the light will always be facing towards the camera and prevents distortion of the frame draw. By default, this is set to a pitch of pi radians and yaw of -pi/4 radians which correspond to custom torch attachment facing directly forward. These values can be changed if the camera is positioned differently.</p>
<pre><code class="python">oOffRots = [pi,0,-pi/4]
</code></pre>

<p>The shake angle simply specified the angle in radians by which the end effector will be offset in yaw during the shake manoeuvre. Generally, this will not need to be changed unless you want the shake to be fast in which case the angle should be reduced.</p>
<pre><code class="python">shakeAngle = pi/8
</code></pre>

<p>Frame Scale is used to adjust the dimensions of the frames within framelist for the animation. Depending on the unit of scale for the animation the frame coordinates need to be scaled to fit with the dexterous workspace of the robot. If the coordinate is outside the workspace then there will either be a motion planning error or the robot will fail to execute the motion plan. In this, the framescale should be reduced to ensure all coordinates are within the acceptable range. Generally, the framescale can be determined by finding the value of the largest coordinate then choosing a framescale which multiplies this value to equal 0.3. This ensures that the frame will all be drawn within a 0.6-metre sized box with its centre and the position of the offset coordinate.</p>
<p>framescale = 0.3 / Largest Coordinate</p>
<p>This value is not automatically calculated as users may want to experiment with drawing larger frames or drawing smaller frames to save time. Additionally, if multiple frames files are used it may be required that these are all scaled by the same value.</p>
<pre><code class="python">frameScale = 0.004
</code></pre>

<p>Processing time is simply the length of time in seconds between the drawing of each frame. This allows time for the camera to process the long exposure photo. This value can be changed to suit the processing time for whichever camera is being used.</p>
<pre><code class="python">processingTime = 20
</code></pre>

<p>Light on and light off distances are the distances in metres which the end effector grabber will open and close to when turning the light on and off during frame drawing. The default values work well for the custom end effector light specified in this documentation. If a different torch design is used these values can be changed as required.</p>
<pre><code class="python">lightOnDist = 0.03
lightOffDist = 0.05
</code></pre>

<p>&nbsp;</p>
<h6 id="main-execution-set-up">Main Execution Set Up</h6>
<hr />
<p>This is the main section of the code which is executed when the program is launched from the terminal. It includes the initial set up as the main loop which is responsible for drawing each frame.</p>
<p>To begin with rospy a new node is created for the panda light controller. Next, the motion planing is initialised with the group name being assigned.</p>
<pre><code class="python">rospy.init_node('panda_light_paint_controller', anonymous=True)

#Initialise motion planning in RVIZ
moveit_commander.roscpp_initialize(sys.argv)    
robot = moveit_commander.RobotCommander()
scene = moveit_commander.PlanningSceneInterface()
group_name = &quot;panda_arm&quot;
group = moveit_commander.MoveGroupCommander(group_name)
</code></pre>

<p>A publisher is created for the controlling the gripper. The message format for the gripper is also specified as a 2d array of float values.</p>
<pre><code class="python">gripper_publisher = rospy.Publisher('/franka/gripper_position_controller/command', Float64MultiArray, queue_size=1)
gripper_msg = Float64MultiArray() #
gripper_msg.layout.dim = [MultiArrayDimension('', 2, 1)]
</code></pre>

<p>Finally the goToPose function is called to set up the robot in it's starting configuration with the end effector at the offset positition at the offset rotation values.</p>
<pre><code class="python">goToPose(oOffRots[0],oOffRots[1],oOffRots[2],oOffCords[0],oOffCords[1],oOffCords[2])
</code></pre>

<p>&nbsp;</p>
<h6 id="main-execution-loop">Main Execution Loop</h6>
<hr />
<p>The main execution loop will be carried out for each frame of the animation in framelist. Each time this loop is executed a frame will be drawn. The loop starts with a terminal message informing the user to open the shutter on the camera. Next, the lightOn function is called which closes the grippers to turn on the torch held by panda. The goOnPath function is executed which draws one frame of the animation. The light is then turned off and a terminal message is printed informing the user to end the current photo. Finally, a delay is carried out to allow time for the camera to process the image before the next frame.</p>
<pre><code class="python">for frame in framelist:

    #User inform message to start photo
    print(&quot;Open Shutter&quot;)

    #Turn on the light by closing the end effector
    lightOn()

    #Wait 1 second
    rospy.sleep(1)

    #Execute frame motion
    goOnPath(frame)

    #Turn off the light by opening the end effector
    lightOff()

    #User inform message to end photo
    print(&quot;Close Shutter&quot;)

    #Wait time so that camera has enough time to process image before next frame
    rospy.sleep(processingTime)
</code></pre>

<p>&nbsp;</p>
<h6 id="gotopose-function">goToPose Function</h6>
<hr />
<p>This function takes the input arguments roll, pitch and yaw, as well as x,y and z coordinates, and will calculate and execute a motion plan to get the robot in the correct pose. This is done by first clearing the old pose targets. Then converting the rotation values into a quaternion which is used to set the new values for the origin pose (which is the target pose). The motion plan is then calculated and executed. If a motion plan cant be found for the chosen pose values and an error message will be displayed in the terminal.</p>
<pre><code class="python">def goToPose(roll,pitch,yaw,xCord,yCord,zCord):
    group.clear_pose_targets()

    quaternion = tf.transformations.quaternion_from_euler(roll, pitch, yaw)
    origin_pose = geometry_msgs.msg.Pose()
    origin_pose.orientation.x = quaternion[0]
    origin_pose.orientation.y = quaternion[1]
    origin_pose.orientation.z = quaternion[2]
    origin_pose.orientation.w = quaternion[3]
    origin_pose.position.x = xCord
    origin_pose.position.y = yCord
    origin_pose.position.z = zCord

    group.set_pose_target(origin_pose)
    plan = group.go(wait=True)
</code></pre>

<p>&nbsp;</p>
<h6 id="shakehand-function">shakeHand Function</h6>
<hr />
<p>This function will execute a number of handshakes specified by the quantity input argument. These handshakes can be used to indicate the start and end of frames to the user when operating the robot if the terminal is not visible by the camera operator. This function can deal with invalid input arguments and will only execute if the integer of the input quantity is greater than 0. An error message will be displayed for invalid input.</p>
<pre><code class="python">def shakeHand(quantity):
    quantity = int(quantity)

    #Check if the quanitty value is valid, if not print error message
    if (quantity &gt;=1):
        for i in range (quantity):
            goToPose(oOffRots[0],oOffRots[1],oOffRots[2]-shakeAngle,oOffCords[0],oOffCords[1],oOffCords[2])
            goToPose(oOffRots[0],oOffRots[1],oOffRots[2]+shakeAngle,oOffCords[0],oOffCords[1],oOffCords[2])
            goToPose(oOffRots[0],oOffRots[1],oOffRots[2],oOffCords[0],oOffCords[1],oOffCords[2])
    else:
        print(&quot;Shake not executed. Shake quantity value needs to be a positive integer&quot;)
</code></pre>

<p>&nbsp;</p>
<h6 id="goonpath-function">goOnPath Function</h6>
<hr />
<p>This function takes a frame of coordinates, as it's input argument, and then executes the drawing of the frame by calculating a motion plan and executing it on the robot. This function works similarly to the goToPose function, however, group.compute_cartesian_path is used to calculate the motion plan as the trajectory is based upon multiple coordinates. The coordinates that make up a frame are converted into drawpose values inside the for loop and these are then added to the list of poses called drawpoints. The motion plan is calculated based on this list of robot poses.</p>
<pre><code class="python">def goOnPath(frame):
    #Clear previous pose targets
    group.clear_pose_targets()

    #Create an empty list to store the frame coordinates
    drawpoints = []

    for coordinate in frame:
        #Calculate the quaternion of the end effector facing forward
        quaternion = tf.transformations.quaternion_from_euler(oOffRots[0],oOffRots[1],oOffRots[2])

        #Initialise the drawpose message 
        drawpose = geometry_msgs.msg.Pose()

        #update the drawpose message base upon the required rotation and coordinate location of the end effector
        drawpose.orientation.x = quaternion[0]
        drawpose.orientation.y = quaternion[1]
        drawpose.orientation.z = quaternion[2]
        drawpose.orientation.w = quaternion[3]
        drawpose.position.x = oOffCords[0] + coordinate[0] *frameScale
        drawpose.position.y = oOffCords[1] + coordinate[1] *frameScale
        drawpose.position.z = oOffCords[2] + coordinate[2] *frameScale

        #Add the drawpose message to the list of drawpoints
        drawpoints.append(copy.deepcopy(drawpose))

    #Calculate motion path base on drawpoints list
    (plan, fraction) = group.compute_cartesian_path(drawpoints, 0.01, 0.0)

    #Execute the calculated motion plan and wait until complete
    group.execute(plan, wait=True) 
</code></pre>

<p>&nbsp;</p>
<h6 id="lighton-function">lightOn Function</h6>
<hr />
<p>This function will turn on the light attached to the end effector by closing the gripper based upon the value set in the lightOnDist variable.</p>
<pre><code class="python">def lightOn():
    gripper_msg.data = [lightOnDist, lightOnDist]
    gripper_publisher.publish(gripper_msg)  
</code></pre>

<p>&nbsp;</p>
<h6 id="lightoff-function">lightOff Function</h6>
<hr />
<p>This function will turn off the light attached to the end effector by opening the gripper based upon the value set in the lightOffDist variable.</p>
<pre><code class="python">def lightOff():
    gripper_msg.data = [lightOffDist, lightOffDist]
    gripper_publisher.publish(gripper_msg)
</code></pre>

<p>&nbsp;</p>
<p>&nbsp;</p>
<h4 id="storing-animation-frames">Storing Animation (frames)</h4>
<hr />
<p>The animation frames are stored in the framelist in the python file frames. This is the output data from the animation creation process in Rhino. Each frame is comprised of a list of 3 value lists which contain a coordinate value [x,y,z]. Multiple frames make up an animation sequence. An example of one frame from the butterfly animation can be seen below.</p>
<pre><code class="python">framelist = [[[0, 0, 0],
[-30.112995, 0, 4.267024],
[-29.869165, 0, -5.730003],
[0, 0, 0],
[19.752333, 0, 5.902996],
[20.161001, 0, -3.087721],
[0, 0, 0],
[-26.639191, -9.011853, -26.175182],
[26.034624, -20.905941, -26.17518],
[0, 0, 0],
[-26.639191, 9.011853, -26.175182],
[26.034624, 20.905941, -26.17518],
[0, 0, 0.1]]]
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../error/" class="btn btn-neutral float-right" title="Error Detection">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../betatest/" class="btn btn-neutral" title="Lo-Fi Development"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../betatest/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../error/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
